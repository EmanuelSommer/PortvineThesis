---
title: "Analysis of the portfolios regarding the MSCI Spain"
author: "Emanuel Sommer"
output: 
  html_document:
    toc: true
    theme: flatly
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In this analysis different portfolios consisting of stocks that are among the top 10 constituents of the MSCI Spain Index are backtested using the functionality of the `portvine` package. First the most important packages are loaded and after that the data will be imported and discussed shortly.

```{r, message=FALSE, warning=FALSE}
library(portvine)
library(tidyverse)
library(patchwork)
# utility color vector for visualizations
yes_no_cols <- c("#92B8DE", "#db4f59")
theme_set(
  theme_minimal() +
  theme(plot.title = ggtext::element_markdown(size = 11),
        plot.subtitle = ggtext::element_markdown(size = 9))
)
# load the data
load(here::here("data", "msci_spain_data_clean.RData"))
```

## A first glimpse at the data

```{r}
glimpse(msci_spain_data)
```

One can see that there are 11 columns. The `date` column gives obviously the date as daily return data will be analyzed here. The daily log returns of the overall index are given in the column `msci_spain_index` and all other columns contain the daily log returns of the respective stock. One can also detect missing values which can be nicely observed in the visualization below.

```{r, echo=FALSE}
msci_spain_data %>%
  rowid_to_column("id") %>%
  pivot_longer(-c(date, id)) %>%
  mutate(missing = is.na(value)) %>%
  ggplot() +
  geom_point(aes(x = date, y = factor(name), col = missing),
             shape = 15, size = 10) +
  scale_color_manual(values = yes_no_cols) +
  scale_y_discrete(labels = ~ str_to_title(str_replace_all(.x, "_", " "))) +
  guides(col = "none") +
  labs(x = "", y = "",
       title = paste("Display asset returns that are ",
                     "<span style='color:",
                     yes_no_cols[1],
                     "'>**available**</span>",
                     " or ",
                     "<span style='color:",
                     yes_no_cols[2],
                     "'>**missing**</span>",
                     "."))
  
```

This makes total sense as for example Cellnex Telecom stocks are traded since 2015, so there can not be earlier return data. So one could now either impute the values in order to use the whole time frame but here the more simplistic approach of just looking at a time frame without any missing values is applied.
This reduced data set is available as `msci_spain_complete_data` and contains only complete cases. 

```{r}
summary(msci_spain_complete_data$date)
nrow(msci_spain_complete_data)
```

This means that the time frame is from the 8th Mai of 2015 until the 8th November of 2021 and there are `r nrow(msci_spain_complete_data)` observations. Below one can have a look at daily log returns of the overall MSCI Spain index.

```{r, echo=FALSE}
ggplot(msci_spain_complete_data, aes(x = date, y = msci_spain_index)) +
  geom_line() +
  labs(x = "", y = "Daily log return",
       title = "MSCI Spain index") 
```

So one can observe greater volatility during the stock market selloffs 2015-2016 maybe due to Chinese stock market turbulences, the EU dept crisis and the Brexit votum as well as for the first 'Covid-19 year' 2020. This should give the opportunity to access how robust the risk measure estimates are during a crisis. With a training data window size of 1000 one would start estimating risk measures from March 2019 so the high volatility corona situation will be covered.

```{r}
# first risk estimate date for 1000 as the training window size
msci_spain_complete_data$date[1001]
```

Now specify the first portfolio and analyze it unconditionally as well as conditionally.


## The missing leader portfolio `missl`

Here one picks as the stock portfolio equally weighted all the stocks without the one with the highest market capitalization that makes roughly 17% of the MSCI Spain i.e. Iberdrola, that is mainly in the energy business. First one models this portfolio and estimates the risk estimates unconditionally and then conditionally on the biggest player Iberdrola. 

### Unconditional `missl` portfolio

First specify suitable marginal model settings as well as settings for the vine copula.

```{r}
missl_marginal_settings <- marginal_settings(
  train_size = 1000,
  refit_size = 50
)

missl_vine_settings <- vine_settings(
  train_size = 200,
  refit_size = 25,
  family_set = "all",
  vine_type = "rvine"
)
```

To compare run times one estimates the risk once sequentially and once in parallel.

```{r}
# sequentially
missl_risk_roll_seq <- estimate_risk_roll(
  msci_spain_complete_data %>% select(-c(date, msci_spain_index, iberdrola)),
  weights = NULL,
  marginal_settings = missl_marginal_settings,
  vine_settings = missl_vine_settings,
  alpha = c(0.01, 0.05, 0.1),
  risk_measures = c("VaR", "ES_mean", "ES_median", "ES_mc"),
  n_samples = 1000,
  n_mc_samples = 1000,
  trace = TRUE
)

# 4 parallel R session
future::plan("multisession", workers = 4)
missl_risk_roll <- estimate_risk_roll(
  msci_spain_complete_data %>% select(-c(date, msci_spain_index, iberdrola)),
  weights = NULL,
  marginal_settings = missl_marginal_settings,
  vine_settings = missl_vine_settings,
  alpha = c(0.01, 0.05, 0.1),
  risk_measures = c("VaR", "ES_mean", "ES_median", "ES_mc"),
  n_samples = 1000,
  n_mc_samples = 1000,
  trace = TRUE
)
future::plan("sequential")
```

The results and their respective run times can be seen below.

```{r}
missl_risk_roll_seq
missl_risk_roll
# thus the speedup is already for 4 workers
missl_risk_roll_seq@time_taken / missl_risk_roll@time_taken
# besides the print method one can also call the summary for more details
summary(missl_risk_roll)
```

#### Inspect marginal and vine copula model fits

Now one can use the accessor functions to extract the fitted marginal as well as the vine copula models. But first one has a close look at the marginal models and can assess their model quality.

```{r, echo=TRUE, results='hide'}
### get the fitted marginal models
missl_fitted_marginals <- fitted_marginals(missl_risk_roll)
# for each asset one now can access the uGARCHroll object that for example 
# contains the fitted coefficients for the second rolling window 

# extract the residuals of the models (helper function maybe include in the
# package)
fitted_stand_resid <- function(ugarchroll, roll_num) {
  total_roll_num <- ugarchroll@model$n.refits
  train_end_index <- ugarchroll@model$n.start
  refit_size <- ugarchroll@model$refit.every
  distribution <- ugarchroll@model$spec@model$modeldesc$distribution
  coefs <- ugarchroll@model$coef[[roll_num]]$coef[, 1]
  spec <- rugarch::ugarchspec(
    distribution.model = distribution, 
    fixed.pars = coefs
  )
  filtered_model <- rugarch::ugarchfilter(
    spec = spec, 
    data = ugarchroll@model$data[seq(1 + refit_size * (roll_num - 1),
                                     min(1 + refit_size * (roll_num - 1) +
                                       train_end_index,
                                       length(ugarchroll@model$data)))]
  )
  as.numeric(rugarch::residuals(filtered_model, standardize = TRUE))
}

# For now analyze the residuals of every first of each asset.
missl_resid_plots <- sapply(
  setdiff(names(msci_spain_complete_data),
          c("msci_spain_index", "iberdrola", "date")),
  function(asset_name) {
    first_model_resid <- fitted_stand_resid(
      missl_fitted_marginals[[asset_name]], 1
    )
    
    simple_exploratory <- tibble(resid = first_model_resid) %>%
      tibble::rowid_to_column(var = "id") %>%
      ggplot(aes(x = id, y = resid)) +
      geom_line(size = 0.2) +
      labs(x = "t", y = expression(z[t]),
           title = str_to_title(str_replace_all(asset_name, "_", " "))) +
      theme(axis.text.x = element_blank(),
            axis.ticks.x = element_blank())
    
    acf_plot <- tibble(
      acf = as.numeric(acf(first_model_resid, type = "cor", lag.max = 20,
                           plot = FALSE)$acf),
      lag = 0:20
    ) %>%
      filter(lag != 0 & lag <= 10) %>%
      ggplot() +
      geom_hline(yintercept = 0, col = "black", size = 0.3) +
      geom_hline(yintercept = qnorm(c(0.025, 0.975)) /
                   sqrt(length(first_model_resid)),
                 linetype = "longdash", col = yes_no_cols[1], size = 0.5) +
      geom_segment(aes(x = lag, xend = lag, y = 0, yend = acf)) +
      geom_point(aes(x = lag, y = acf)) +
      scale_x_continuous(breaks = seq(1, 10, 1)) +
      ylim(-1, 1) +
      labs(x = "h", y = "ACF(h)")
    
    ljungplot <- tibble(
      pval = sapply(
        1:10,
        function(i) Box.test(first_model_resid, lag = i,
                             type = "Lju")$p.value),
      lag = 1:10) %>%
      ggplot() +
      geom_hline(yintercept = 0, col = "black", size = 0.3) +
      geom_hline(yintercept = 0.05,
                 linetype = "longdash", col = yes_no_cols[1], size = 0.5) +
      geom_line(aes(x = lag, y = pval)) +
      geom_point(aes(x = lag, y = pval)) +
      scale_x_continuous(breaks = seq(1, 10, 1)) +
      labs(x = "h", y = "p-value of Ljung-Box test at lag h")
    
    (simple_exploratory / (ljungplot + acf_plot)) +
      plot_layout(nrow = 2)
  }, USE.NAMES = TRUE, simplify = FALSE)
```

```{r}
# exemplary 2 plots, all plots showed basically the same behavior like the ones
# below
missl_resid_plots$telefonica
missl_resid_plots$repsol_ypf
```


So overall the marginal models seem to satisfy the model assumptions. Notably there were many cases with a heavier lower tail which can be explained by the high volatility corona crisis. As already the skewed student's t distribution was chosen for the residual distribution one already accounts for heavy tails.

Now one can have a look at the fitted vine copulas. Again there is an appropriate accessor function that helps with extracting them. After that one can visually inspect how the first tree of the vines has changed over time.

```{r}
### get the fitted vine copula models
missl_fitted_vines <- fitted_vines(missl_risk_roll)
# then one can for example have a look at how the fitted vine structure evolved
#  over time by plotting the first tree for different rolling windows
rvinecopulib:::plot.vinecop(missl_fitted_vines[[1]])
rvinecopulib:::plot.vinecop(missl_fitted_vines[[14]])
rvinecopulib:::plot.vinecop(missl_fitted_vines[[28]])
```

A quick mapping table for the number might help for the interpretation

```{r, echo=FALSE}
tibble(
  number = 1:8,
  asset = setdiff(names(msci_spain_complete_data),
          c("msci_spain_index", "iberdrola", "date"))
)
```

The first two assets seem to be very important in their dependence structure.


#### Analyze estimated risk measures

Now finally the risk estimates are going to be analyzed. First one compares the 3 different methods of estimating the Expected Shortfall.

```{r, echo=FALSE}
risk_estimates(missl_risk_roll,
               risk_measures = c("ES_mean", "ES_median", "ES_mc"),
               alpha = 0.05) %>%
  pivot_wider(names_from = risk_measure, values_from = risk_est) %>%
  plotly::plot_ly(x = ~ES_mean, y = ~ES_median, z = ~ES_mc,
                  marker = list(symbol = 'circle', color = "black",
                                size = 2),
                  text = ~ paste('Row:', row_num)) %>%
  plotly::add_markers(opacity = 0.2) %>%
  plotly::layout(
    scene = list(xaxis = list(title = 'Mean'),
                 yaxis = list(title = 'Median'),
                 zaxis = list(title = 'Monte Carlo')),
    title = "Empirical comparison of Expected Shortfall estimatiors"
  )
```

Also one might compare the number of exceedances.

```{r}
risk_estimates(missl_risk_roll,
               risk_measures = c("ES_mean", "ES_median", "ES_mc"),
               alpha = 0.05,
               exceeded = TRUE) %>%
  group_by(risk_measure) %>%
  summarise(relative_exceedances = mean(exceeded))
```

Here actually we find an indication for the fact that the values that fell below the corresponding VaR where left skewed which leads to the fact that the mean will be a more conservative estimate in those cases which might explain the slightly lower exceedance rate.

### Exceedance plots

```{r, echo=TRUE}
risk_estimates(missl_risk_roll,
               risk_measures = c("ES_mean", "VaR"),
               alpha = 0.01) %>%
  ggplot() +
  geom_line(aes(x = row_num, y = realized), col = "lightgrey") +
  geom_line(aes(x = row_num, y = risk_est,
                col = risk_measure, linetype = risk_measure),
            size = 0.5) +
  labs(x = "estimation window", y = "portfolio log returns",
       linetype = "Risk measure",
       title = "Comparison of risk measure behaivior for alpha level 0.01") +
  scale_color_manual(values = c(yes_no_cols[1], "#477042"),
                     name = "Risk measure") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
```

```{r}
risk_estimates(missl_risk_roll,
               risk_measures = c("VaR"),
               alpha = 0.01,
               exceeded = TRUE) %>%
  ggplot() +
  geom_line(aes(x = row_num, y = realized), col = "lightgrey") +
  geom_line(aes(x = row_num, y = risk_est), col = yes_no_cols[1]) +
  geom_point(aes(x = row_num, y = realized), col = yes_no_cols[2], 
             inherit.aes = FALSE, data = . %>% filter(exceeded)) +
  labs(x = "estimation window",
       y = "portfolio log returns",
       col = "Exceeded",
       subtitle = paste0("Exceedances are highlighted in ",
                     "<span style='color:",
                     yes_no_cols[2],
                     "'>**red**</span>",
                     "."),
       title = "Risk measure: VaR with alpha level 0.01"
       ) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "none")

risk_estimates(missl_risk_roll,
               risk_measures = c("ES_mean"),
               alpha = 0.01,
               exceeded = TRUE) %>%
  ggplot() +
  geom_line(aes(x = row_num, y = realized), col = "lightgrey") +
  geom_line(aes(x = row_num, y = risk_est), col = yes_no_cols[1]) +
  geom_point(aes(x = row_num, y = realized), col = yes_no_cols[2], 
             inherit.aes = FALSE, data = . %>% filter(exceeded)) +
  labs(x = "estimation window",
       y = "portfolio log returns",
       col = "Exceeded",
       subtitle = paste0("Exceedances are highlighted in ",
                     "<span style='color:",
                     yes_no_cols[2],
                     "'>**red**</span>",
                     "."),
       title = "Risk measure: ES (mean estimation) with alpha level 0.01"
       ) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "none")
```

Also fit the unconditional `missl` portfolio with only D vine copulas allowed to compare these D vines with the then conditional ones.

```{r}
missl_vine_settings_d <- vine_settings(
  train_size = 200,
  refit_size = 25,
  family_set = "all",
  vine_type = "dvine"
)
future::plan("multisession", workers = 6)
missl_risk_roll_d <- estimate_risk_roll(
  msci_spain_complete_data %>% select(-c(date, msci_spain_index, iberdrola)),
  weights = NULL,
  marginal_settings = missl_marginal_settings,
  vine_settings = missl_vine_settings_d,
  alpha = c(0.01, 0.05, 0.1),
  risk_measures = c("VaR", "ES_mean", "ES_median", "ES_mc"),
  n_samples = 1000,
  n_mc_samples = 1000,
  trace = TRUE
)
future::plan("sequential")
```


### Conditional `missl` portfolio

Estimation is performed in the same fashion as above with some additional arguments concerning the conditioning on the stock Iberdrola.

```{r}
missl_cond_marginal_settings <- marginal_settings(
  train_size = 1000,
  refit_size = 50
)

missl_cond_vine_settings <- vine_settings(
  train_size = 200,
  refit_size = 25,
  family_set = "parametric",
  vine_type = "dvine"
)

future::plan("multisession", workers = 6)
missl_cond_risk_roll <- estimate_risk_roll(
  msci_spain_complete_data %>% select(-c(date, msci_spain_index)),
  weights = NULL,
  marginal_settings = missl_cond_marginal_settings,
  vine_settings = missl_cond_vine_settings,
  alpha = c(0.01, 0.05, 0.1),
  risk_measures = c("VaR", "ES_mean", "ES_median", "ES_mc"),
  n_samples = 1000,
  n_mc_samples = 1000,
  cond_vars = "iberdrola",
  cond_alpha = c(0.05, 0.5),
  trace = TRUE
)
future::plan("sequential")
```

```{r}
summary(missl_cond_risk_roll)
```

Compare the fitted conditional vines with the ones of the unconditional dvine fitting.

```{r}
# unconditional first
rvinecopulib:::plot.vinecop(fitted_vines(missl_risk_roll_d)[[1]])
# conditional first
rvinecopulib:::plot.vinecop(fitted_vines(missl_cond_risk_roll)[[1]])
# unconditional last
rvinecopulib:::plot.vinecop(fitted_vines(missl_risk_roll_d)[[28]])
# conditional last
rvinecopulib:::plot.vinecop(fitted_vines(missl_cond_risk_roll)[[28]])
```

Notably for the conditional case the following mapping applies:

```{r, echo=FALSE}
tibble(
  number = 1:9,
  asset = setdiff(names(msci_spain_complete_data),
          c("msci_spain_index", "date"))
)
```

```{r}
# what about the evolution of the conditional values (iberdrola)
risk_estimates(missl_cond_risk_roll, risk_measures = "ES_mean",
               alpha = 0.05, exceeded = TRUE) %>%
  ggplot() +
  geom_line(
    data = msci_spain_complete_data[1001:nrow(msci_spain_complete_data), ],
    aes(x = 1001:nrow(msci_spain_complete_data),
        y = iberdrola), col = "lightgrey", size = .3) +
  geom_line(aes(x = row_num, y = iberdrola, col = factor(cond_alpha)),
            size = 0.5) +
  scale_color_manual(values = c(yes_no_cols[1], "#477042"),
                     name = "Conditional alpha level") +
  labs(title = "Conditional variable: Iberdrola",
       x = "estimation window", y = "log returns") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
```

Nice to see so we expect the corresponding conditional risk measures with low conditional $\alpha$ level to be way more conservative under the assumption that Iberdrola has a generally positive dependence with the portfolio of interest. Therefore look at the next plot.

```{r}
risk_estimates(missl_cond_risk_roll, risk_measures = "ES_mean",
               alpha = 0.05, exceeded = TRUE) %>%
  ggplot() +
  geom_line(aes(x = row_num, y = realized), col = "lightgrey") +
  geom_line(aes(x = row_num, y = risk_est,
                col = factor(cond_alpha), linetype = factor(cond_alpha)),
            size = 0.5) +
  labs(x = "estimation window", y = "portfolio log returns",
       linetype = "Conditional alpha level",
       title = "Comparison of risk measure behaivior for 2 conditional alpha levels") +
  scale_color_manual(values = c(yes_no_cols[1], "#477042"),
                     name = "Conditional alpha level") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
```


A close look wrt exceedences.

```{r}
risk_estimates(missl_cond_risk_roll, risk_measures = "ES_mean",
               cond_alpha = 0.5,
               alpha = 0.05, exceeded = TRUE) %>%
  ggplot() +
  geom_line(aes(x = row_num, y = realized), col = "lightgrey") +
  geom_line(aes(x = row_num, y = risk_est), col = yes_no_cols[1]) +
  geom_point(aes(x = row_num, y = realized), col = yes_no_cols[2], 
             inherit.aes = FALSE, data = . %>% filter(exceeded)) +
  labs(x = "estimation window",
       y = "portfolio log returns",
       col = "Exceeded",
       subtitle = paste0("Exceedances are highlighted in ",
                     "<span style='color:",
                     yes_no_cols[2],
                     "'>**red**</span>",
                     "."),
       title = "Risk measure: ES (mean estimation) with alpha level 0.05, conditional alpha level 0.5"
       ) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "none")

risk_estimates(missl_cond_risk_roll, risk_measures = "ES_mean",
               cond_alpha = 0.05,
               alpha = 0.05, exceeded = TRUE) %>%
  ggplot() +
  geom_line(aes(x = row_num, y = realized), col = "lightgrey") +
  geom_line(aes(x = row_num, y = risk_est), col = yes_no_cols[1]) +
  geom_point(aes(x = row_num, y = realized), col = yes_no_cols[2], 
             inherit.aes = FALSE, data = . %>% filter(exceeded)) +
  labs(x = "estimation window",
       y = "portfolio log returns",
       col = "Exceeded",
       subtitle = paste0("Exceedances are highlighted in ",
                     "<span style='color:",
                     yes_no_cols[2],
                     "'>**red**</span>",
                     "."),
       title = "Risk measure: ES (mean estimation) with alpha and conditional alpha level 0.05"
       ) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "none")
```

While the 0.5 conditional value leads to lots of exceedances (not surprisingly) the conditional value of 0.05 shows not many exceedances. For a rough comparison one can have a short comparison with the above fitted unconditional ES with mean estimation for the same confidence level.

```{r}
risk_estimates(missl_risk_roll,
               risk_measures = c("ES_mean"),
               alpha = 0.05,
               exceeded = TRUE) %>%
  ggplot() +
  geom_line(aes(x = row_num, y = realized), col = "lightgrey") +
  geom_line(aes(x = row_num, y = risk_est), col = yes_no_cols[1]) +
  geom_point(aes(x = row_num, y = realized), col = yes_no_cols[2], 
             inherit.aes = FALSE, data = . %>% filter(exceeded)) +
  labs(x = "estimation window",
       y = "portfolio log returns",
       col = "Exceeded",
       subtitle = paste0("Exceedances are highlighted in ",
                     "<span style='color:",
                     yes_no_cols[2],
                     "'>**red**</span>",
                     "."),
       title = "Risk measure: ES (mean estimation) with alpha level 0.05"
       ) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "none")
```

So in the direct comparison the conditional risk measure is way more conservative and might help in stresstesting situations for projected hard times of specific conditional assets.


## Double conditional short trial

Here just the estimation with two conditional values is tested shortly.

```{r}
cond2test_marginal_settings <- marginal_settings(
  train_size = 1000,
  refit_size = 50
)

cond2test_vine_settings <- vine_settings(
  train_size = 200,
  refit_size = 25,
  family_set = "parametric",
  vine_type = "dvine"
)

future::plan("multisession", workers = 6)
cond2test_risk_roll <- estimate_risk_roll(
  msci_spain_complete_data %>% select(-c(date, msci_spain_index)),
  weights = NULL,
  marginal_settings = cond2test_marginal_settings,
  vine_settings = cond2test_vine_settings,
  alpha = c(0.01, 0.05, 0.1),
  risk_measures = c("VaR", "ES_mean", "ES_median", "ES_mc"),
  n_samples = 1000,
  n_mc_samples = 1000,
  cond_vars = c("iberdrola", "banco_santander"),
  cond_alpha = c(0.05, 0.5),
  trace = TRUE
)
future::plan("sequential")
```

```{r}
summary(cond2test_risk_roll)
risk_estimates(cond2test_risk_roll)
```

















